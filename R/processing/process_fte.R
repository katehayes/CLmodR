load("/Users/katehayes/CLmodelR/Output/Data/Cleaned/fte_09to20.Rdata")
load("/Users/katehayes/CLmodelR/Output/Data/Cleaned/fte_09to21_disposal_gender.Rdata")
load("/Users/katehayes/CLmodelR/Output/Data/Cleaned/fte_09to21_offence_gender.Rdata")




fte_p1c1s1_10 <- np2nci10[,1]
fte_p1c1s2_10 <- np2nci10[,1]
fte_p1c1s3_10 <- np2nci10[,1]
fte_p1c2s1_10 <- np2nci10[,1]
fte_p1c2s2_10 <- np2nci10[,1]
fte_p1c2s3_10 <- np2nci10[,1]
fte_p1c3s1_10 <- np2nci10[,1]
fte_p1c3s2_10 <- np2nci10[,1]
fte_p1c3s3_10 <- np2nci10[,1]
fte_p1c4s1_10 <- np2nci10[,1]
fte_p1c4s2_10 <- np2nci10[,1]
fte_p1c4s3_10 <- np2nci10[,1]
fte_p2c1s1_10 <- np2ncec10[,1]
fte_p2c1s2_10 <- np2ncec10[,1]
fte_p2c1s3_10 <- np2ncec10[,1]
fte_p2c2s1_10 <- np2ncec10[,1]
fte_p2c2s2_10 <- np2ncec10[,1]
fte_p2c2s3_10 <- np2ncec10[,1]
fte_p2c3s1_10 <- np2ncec10[,1]
fte_p2c3s2_10 <- np2ncec10[,1]
fte_p2c3s3_10 <- np2ncec10[,1]
fte_p2c4s1_10 <- np2ncec10[,1]
fte_p2c4s2_10 <- np2ncec10[,1]
fte_p2c4s3_10 <- np2ncec10[,1]
fte_p1c1s1_11 <- np2nci11[,1]
fte_p1c1s2_11 <- np2nci11[,1]
fte_p1c1s3_11 <- np2nci11[,1]
fte_p1c2s1_11 <- np2nci11[,1]
fte_p1c2s2_11 <- np2nci11[,1]
fte_p1c2s3_11 <- np2nci11[,1]
fte_p1c3s1_11 <- np2nci11[,1]
fte_p1c3s2_11 <- np2nci11[,1]
fte_p1c3s3_11 <- np2nci11[,1]
fte_p1c4s1_11 <- np2nci11[,1]
fte_p1c4s2_11 <- np2nci11[,1]
fte_p1c4s3_11 <- np2nci11[,1]
fte_p2c1s1_11 <- np2ncec11[,1]
fte_p2c1s2_11 <- np2ncec11[,1]
fte_p2c1s3_11 <- np2ncec11[,1]
fte_p2c2s1_11 <- np2ncec11[,1]
fte_p2c2s2_11 <- np2ncec11[,1]
fte_p2c2s3_11 <- np2ncec11[,1]
fte_p2c3s1_11 <- np2ncec11[,1]
fte_p2c3s2_11 <- np2ncec11[,1]
fte_p2c3s3_11 <- np2ncec11[,1]
fte_p2c4s1_11 <- np2ncec11[,1]
fte_p2c4s2_11 <- np2ncec11[,1]
fte_p2c4s3_11 <- np2ncec11[,1]
fte_p1c1s1_12 <- np2nci12[,1]
fte_p1c1s2_12 <- np2nci12[,1]
fte_p1c1s3_12 <- np2nci12[,1]
fte_p1c2s1_12 <- np2nci12[,1]
fte_p1c2s2_12 <- np2nci12[,1]
fte_p1c2s3_12 <- np2nci12[,1]
fte_p1c3s1_12 <- np2nci12[,1]
fte_p1c3s2_12 <- np2nci12[,1]
fte_p1c3s3_12 <- np2nci12[,1]
fte_p1c4s1_12 <- np2nci12[,1]
fte_p1c4s2_12 <- np2nci12[,1]
fte_p1c4s3_12 <- np2nci12[,1]
fte_p2c1s1_12 <- np2ncec12[,1]
fte_p2c1s2_12 <- np2ncec12[,1]
fte_p2c1s3_12 <- np2ncec12[,1]
fte_p2c2s1_12 <- np2ncec12[,1]
fte_p2c2s2_12 <- np2ncec12[,1]
fte_p2c2s3_12 <- np2ncec12[,1]
fte_p2c3s1_12 <- np2ncec12[,1]
fte_p2c3s2_12 <- np2ncec12[,1]
fte_p2c3s3_12 <- np2ncec12[,1]
fte_p2c4s1_12 <- np2ncec12[,1]
fte_p2c4s2_12 <- np2ncec12[,1]
fte_p2c4s3_12 <- np2ncec12[,1]
fte_p1c1s1_13 <- np2nci13[,1]
fte_p1c1s2_13 <- np2nci13[,1]
fte_p1c1s3_13 <- np2nci13[,1]
fte_p1c2s1_13 <- np2nci13[,1]
fte_p1c2s2_13 <- np2nci13[,1]
fte_p1c2s3_13 <- np2nci13[,1]
fte_p1c3s1_13 <- np2nci13[,1]
fte_p1c3s2_13 <- np2nci13[,1]
fte_p1c3s3_13 <- np2nci13[,1]
fte_p1c4s1_13 <- np2nci13[,1]
fte_p1c4s2_13 <- np2nci13[,1]
fte_p1c4s3_13 <- np2nci13[,1]
fte_p2c1s1_13 <- np2ncec13[,1]
fte_p2c1s2_13 <- np2ncec13[,1]
fte_p2c1s3_13 <- np2ncec13[,1]
fte_p2c2s1_13 <- np2ncec13[,1]
fte_p2c2s2_13 <- np2ncec13[,1]
fte_p2c2s3_13 <- np2ncec13[,1]
fte_p2c3s1_13 <- np2ncec13[,1]
fte_p2c3s2_13 <- np2ncec13[,1]
fte_p2c3s3_13 <- np2ncec13[,1]
fte_p2c4s1_13 <- np2ncec13[,1]
fte_p2c4s2_13 <- np2ncec13[,1]
fte_p2c4s3_13 <- np2ncec13[,1]
fte_p1c1s1_14 <- np2nci14[,1]
fte_p1c1s2_14 <- np2nci14[,1]
fte_p1c1s3_14 <- np2nci14[,1]
fte_p1c2s1_14 <- np2nci14[,1]
fte_p1c2s2_14 <- np2nci14[,1]
fte_p1c2s3_14 <- np2nci14[,1]
fte_p1c3s1_14 <- np2nci14[,1]
fte_p1c3s2_14 <- np2nci14[,1]
fte_p1c3s3_14 <- np2nci14[,1]
fte_p1c4s1_14 <- np2nci14[,1]
fte_p1c4s2_14 <- np2nci14[,1]
fte_p1c4s3_14 <- np2nci14[,1]
fte_p2c1s1_14 <- np2ncec14[,1]
fte_p2c1s2_14 <- np2ncec14[,1]
fte_p2c1s3_14 <- np2ncec14[,1]
fte_p2c2s1_14 <- np2ncec14[,1]
fte_p2c2s2_14 <- np2ncec14[,1]
fte_p2c2s3_14 <- np2ncec14[,1]
fte_p2c3s1_14 <- np2ncec14[,1]
fte_p2c3s2_14 <- np2ncec14[,1]
fte_p2c3s3_14 <- np2ncec14[,1]
fte_p2c4s1_14 <- np2ncec14[,1]
fte_p2c4s2_14 <- np2ncec14[,1]
fte_p2c4s3_14 <- np2ncec14[,1]
fte_p1c1s1_15 <- np2nci15[,1]
fte_p1c1s2_15 <- np2nci15[,1]
fte_p1c1s3_15 <- np2nci15[,1]
fte_p1c2s1_15 <- np2nci15[,1]
fte_p1c2s2_15 <- np2nci15[,1]
fte_p1c2s3_15 <- np2nci15[,1]
fte_p1c3s1_15 <- np2nci15[,1]
fte_p1c3s2_15 <- np2nci15[,1]
fte_p1c3s3_15 <- np2nci15[,1]
fte_p1c4s1_15 <- np2nci15[,1]
fte_p1c4s2_15 <- np2nci15[,1]
fte_p1c4s3_15 <- np2nci15[,1]
fte_p2c1s1_15 <- np2ncec15[,1]
fte_p2c1s2_15 <- np2ncec15[,1]
fte_p2c1s3_15 <- np2ncec15[,1]
fte_p2c2s1_15 <- np2ncec15[,1]
fte_p2c2s2_15 <- np2ncec15[,1]
fte_p2c2s3_15 <- np2ncec15[,1]
fte_p2c3s1_15 <- np2ncec15[,1]
fte_p2c3s2_15 <- np2ncec15[,1]
fte_p2c3s3_15 <- np2ncec15[,1]
fte_p2c4s1_15 <- np2ncec15[,1]
fte_p2c4s2_15 <- np2ncec15[,1]
fte_p2c4s3_15 <- np2ncec15[,1]
fte_p1c1s1_16 <- np2nci16[,1]
fte_p1c1s2_16 <- np2nci16[,1]
fte_p1c1s3_16 <- np2nci16[,1]
fte_p1c2s1_16 <- np2nci16[,1]
fte_p1c2s2_16 <- np2nci16[,1]
fte_p1c2s3_16 <- np2nci16[,1]
fte_p1c3s1_16 <- np2nci16[,1]
fte_p1c3s2_16 <- np2nci16[,1]
fte_p1c3s3_16 <- np2nci16[,1]
fte_p1c4s1_16 <- np2nci16[,1]
fte_p1c4s2_16 <- np2nci16[,1]
fte_p1c4s3_16 <- np2nci16[,1]
fte_p2c1s1_16 <- np2ncec16[,1]
fte_p2c1s2_16 <- np2ncec16[,1]
fte_p2c1s3_16 <- np2ncec16[,1]
fte_p2c2s1_16 <- np2ncec16[,1]
fte_p2c2s2_16 <- np2ncec16[,1]
fte_p2c2s3_16 <- np2ncec16[,1]
fte_p2c3s1_16 <- np2ncec16[,1]
fte_p2c3s2_16 <- np2ncec16[,1]
fte_p2c3s3_16 <- np2ncec16[,1]
fte_p2c4s1_16 <- np2ncec16[,1]
fte_p2c4s2_16 <- np2ncec16[,1]
fte_p2c4s3_16 <- np2ncec16[,1]
fte_p1c1s1_17 <- np2nci17[,1]
fte_p1c1s2_17 <- np2nci17[,1]
fte_p1c1s3_17 <- np2nci17[,1]
fte_p1c2s1_17 <- np2nci17[,1]
fte_p1c2s2_17 <- np2nci17[,1]
fte_p1c2s3_17 <- np2nci17[,1]
fte_p1c3s1_17 <- np2nci17[,1]
fte_p1c3s2_17 <- np2nci17[,1]
fte_p1c3s3_17 <- np2nci17[,1]
fte_p1c4s1_17 <- np2nci17[,1]
fte_p1c4s2_17 <- np2nci17[,1]
fte_p1c4s3_17 <- np2nci17[,1]
fte_p2c1s1_17 <- np2ncec17[,1]
fte_p2c1s2_17 <- np2ncec17[,1]
fte_p2c1s3_17 <- np2ncec17[,1]
fte_p2c2s1_17 <- np2ncec17[,1]
fte_p2c2s2_17 <- np2ncec17[,1]
fte_p2c2s3_17 <- np2ncec17[,1]
fte_p2c3s1_17 <- np2ncec17[,1]
fte_p2c3s2_17 <- np2ncec17[,1]
fte_p2c3s3_17 <- np2ncec17[,1]
fte_p2c4s1_17 <- np2ncec17[,1]
fte_p2c4s2_17 <- np2ncec17[,1]
fte_p2c4s3_17 <- np2ncec17[,1]







# gender_pc_fte <- fte_09to21_disposal_gender %>%
#   filter(!(end_period_year >= 2011 & end_period_month == "December")) %>%
#   group_by(level, end_period_year, end_period_month, gender) %>%
#   summarise(count = sum(count)) %>%
#   ungroup() %>%
#   group_by(end_period_year, end_period_month) %>%
#   mutate(tot = sum(count),
#          pc = count / tot)
#
# gender_pc_tot <- children_10to21_gender %>%
#   filter(level == "Eng/Wales") %>%
#   group_by(level, end_period_year, end_period_month, gender) %>%
#   summarise(count = sum(count)) %>%
#   ungroup() %>%
#   group_by(end_period_year, end_period_month) %>%
#   mutate(tot = sum(count),
#          pc = count / tot)
#
#
# check_fte_v_tot_pc <- gender_pc_fte %>%
#   mutate(measure = "FTE") %>%
#   bind_rows(gender_pc_tot %>%
#               # filter(gender != "Unknown") %>%
#               mutate(measure = "Total")) %>%
#   ggplot() +
#   geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, measure))) +
#   scale_x_continuous(name = "") +
#   scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
#   theme_classic() +
#   theme(strip.background = element_blank())
# check_fte_v_tot_pc
#
# ggsave(filename = "Output/Graphs/assumption_checks/fte_v_tot_gender_ew.png", check_fte_v_tot_pc)
#
#
# check_fte_v_tot_pc <- gender_pc_fte %>%
#   mutate(measure = "FTE") %>%
#   bind_rows(gender_pc_tot %>%
#               # filter(gender != "Unknown") %>%
#               mutate(measure = "Total")) %>%
#   ggplot() +
#   geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, measure))) +
#   scale_x_continuous(name = "") +
#   scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
#   theme_classic() +
#   theme(strip.background = element_blank())
# check_fte_v_tot_pc
#
# ggsave(filename = "Output/Graphs/assumption_checks/fte_v_tot_gender_ew.png", check_fte_v_tot_pc)
#
# gender_pc <- gender_pc_fte %>%
#   mutate(measure = "FTE") %>%
#   bind_rows(gender_pc_tot %>%
#               # filter(gender != "Unknown") %>%
#               mutate(measure = "Total")) %>%
#   ungroup() %>%
#   select(-c(level, end_period_month, count, tot)) %>%
#   pivot_wider(names_from = measure, values_from = pc) %>%
#   mutate(tot_to_fte_scale = FTE / Total) %>%
#   filter(!is.na(tot_to_fte_scale)) %>%
#   select(end_period_year, gender, tot_to_fte_scale)
#
# # so processing children must come first for this......just bc otherwise theres no 2010 birm
# load("/Users/katehayes/CLmodelR/Output/Data/Processed/children.Rdata")
#
# gender_pc_tot_birm <- children %>%
#   group_by(end_period_year, gender) %>%
#   summarise(count = sum(count)) %>%
#   ungroup() %>%
#   group_by(end_period_year) %>%
#   mutate(tot = sum(count),
#          pc = count / tot) %>%
#   select(-c(count, tot)) %>%
#   full_join(gender_pc) %>%
#   mutate(fte_pc = pc * tot_to_fte_scale) %>%
#   filter(gender != "Unknown") %>%
#   select(end_period_year, gender, fte_pc) %>%
#   ungroup() %>%
#   pivot_wider(names_from = gender, values_from = fte_pc) %>% #small pc lost bc of unknowns probably - just going to fill up to 1
#   mutate(tot = Girls + Boys,
#          check = 1 - tot) %>%
#   mutate(across(c(Boys, Girls), ~ .x + (.x / tot) * check)) %>%
#   select(-c(tot, check)) %>%
#   pivot_longer(c(Boys, Girls),
#                names_to = "gender", values_to = "fte_pc")
#
# gender_pc_tot_birm <- gender_pc_tot_birm %>%
#   bind_rows(gender_pc_tot_birm %>%
#               filter(end_period_year == 2010) %>%
#               mutate(end_period_year = end_period_year - 1))
#
#
# level_pc <- fte_09to20 %>%
#   pivot_wider(names_from = level, values_from = count) %>%
#   mutate(pc = Birmingham / `Eng/Wales`) %>%
#   filter(end_period_year == 2020) %>%
#   select(pc) %>%
#   unlist()
#
#
#
# fte <- fte_09to20 %>%
#   filter(level == "Birmingham") %>%
#   bind_rows(fte_09to21_disposal_gender %>% # adding scaled down fte total for 2021
#               ungroup() %>%
#               filter(end_period_year == 2021) %>%
#               group_by(end_period_year, end_period_month, period_length, level) %>%
#               summarise(count = sum(count)) %>%
#               mutate(count = count * level_pc,
#                      level = "Birmingham (estimate)")) %>%
#   full_join(gender_pc_tot_birm) %>%
#   mutate(count = count * fte_pc) %>%
#   select(-fte_pc) %>%
#   ungroup()
#
# # THIS ONLY HAS GENDER, NOT AGE
# save(fte, file = "Output/Data/Processed/fte.Rdata")
#
#
# check_fte <- children %>%
#   group_by(end_period_year, gender) %>%
#   summarise(count = sum(count)) %>%
#   rename(total = count) %>%
#   ungroup() %>%
#   full_join(fte %>%
#               select(end_period_year, gender, count) %>%
#               rename(fte = count)) %>%
#   mutate(pc = fte / total)
#
#
# check_fte_tot <- check_fte %>%
#   ggplot() +
#   geom_line(aes(x = end_period_year, y = pc, colour = gender)) +
#   scale_x_continuous(name = "") +
#   scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
#   theme_classic() +
#   theme(strip.background = element_blank())
# check_fte_tot
#
# ggsave(filename = "Output/Graphs/assumption_checks/fte_v_tot_gender_birm.png", check_fte_tot)



# taking it the other way, getting fte girls as pc of tot girls etc
# gender_pc <- fte_09to21_disposal_gender %>%
#   filter(!(end_period_year >= 2011 & end_period_month == "December")) %>%
#   group_by(level, end_period_year, end_period_month, gender) %>%
#   summarise(count = sum(count)) %>%
#   ungroup() %>%
#   mutate(measure = "FTE") %>%
#   bind_rows(children_10to21_gender %>%
#               filter(level == "Eng/Wales") %>%
#               group_by(level, end_period_year, end_period_month, gender) %>%
#               summarise(count = sum(count)) %>%
#               ungroup() %>%
#               mutate(measure = "Total")) %>%
#   select(-end_period_month) %>%
#   pivot_wider(names_from = measure, values_from = count) %>%
#   mutate(pc = FTE / Total)
#
# check_gender_pc <- gender_pc %>%
#   ggplot() +
#   geom_line(aes(x = end_period_year, y = pc, colour = gender)) +
#   scale_x_continuous(name = "") +
#   scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
#   theme_classic() +
#   theme(strip.background = element_blank())
# check_gender_pc
# ggsave(filename = "Output/Graphs/assumption_checks/pc_fte_of_total_ew_gender.png", check_gender_pc)


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# disposals - trying to figure out pc of fte that go to custody # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


gen_disp_fte <- fte_09to21_disposal_gender %>%
  filter(!(end_period_year >= 2011 & end_period_month == "December")) %>%
  group_by(level, end_period_year, end_period_month, gender, disposal_type) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  group_by(end_period_year, end_period_month) %>%
  mutate(tot = sum(count),
         pc = count / tot)


# so processing disposal must come first for this.??
load("/Users/katehayes/CLmodelR/Output/Data/Processed/disposals.Rdata")

gen_disp_tot_ew <- disposals %>%
  filter(level == "Eng/Wales") %>%
  group_by(level, end_period_year, end_period_month, gender, disposal_type) %>%
  summarise(count = sum(count)) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  ungroup() %>%
  group_by(end_period_year, end_period_month) %>%
  mutate(tot = sum(count),
         pc = count / tot)

gen_disp_tot_birm <- disposals %>%
  filter(level == "Birmingham") %>%
  group_by(level, end_period_year, end_period_month, gender, disposal_type) %>%
  summarise(count = sum(count)) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  ungroup() %>%
  group_by(end_period_year, end_period_month) %>%
  mutate(tot = sum(count),
         pc = count / tot)


check_fte_v_tot_pc <- gen_disp_fte %>%
  mutate(measure = "FTE") %>%
  bind_rows(gen_disp_tot %>%
              mutate(measure = "Total")) %>%
  filter(gender != "Unknown",
         disposal_type != "Other") %>%
  mutate(disposal_type = factor(disposal_type,
                                levels = c("Pre-court", "First-tier", "Community", "Custody"))) %>%
  ggplot() +
  geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, measure))) +
  facet_grid(~disposal_type) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
check_fte_v_tot_pc

ggsave(filename = "Output/Graphs/assumption_checks/fte_v_tot_gen_disposal_ew.png", check_fte_v_tot_pc)


check_birm_v_ew_tot_pc <- gen_disp_tot_ew %>%
  bind_rows(gen_disp_tot_birm) %>%
  filter(gender != "Unknown",
         disposal_type != "Other") %>%
  mutate(disposal_type = factor(disposal_type,
                                levels = c("Pre-court", "First-tier", "Community", "Custody"))) %>%
  ggplot() +
  geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, level))) +
  facet_grid(~disposal_type) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
check_birm_v_ew_tot_pc

ggsave(filename = "Output/Graphs/assumption_checks/birm_v_ew_tot_gen_disposal_ew.png", check_birm_v_ew_tot_pc)


gen_disp_pc <- gen_disp_tot_ew %>%
  bind_rows(gen_disp_tot_birm) %>%
  filter(gender != "Unknown",
         disposal_type != "Other") %>%
  ungroup() %>%
  select(-c(end_period_month, count, tot)) %>%
  pivot_wider(names_from = level, values_from = pc) %>%
  mutate(ew_to_birm_scale = Birmingham / `Eng/Wales`) %>%
  filter(!is.na(ew_to_birm_scale)) %>%
  select(end_period_year, disposal_type, gender, ew_to_birm_scale)


# gen_disp_pc <- gen_disp_fte %>%
#   mutate(measure = "FTE") %>%
#   bind_rows(gen_disp_tot %>%
#               mutate(measure = "Total")) %>%
#   filter(gender != "Unknown",
#          disposal_type != "Other") %>%
#   ungroup() %>%
#   select(-c(level, end_period_month, count, tot)) %>%
#   pivot_wider(names_from = measure, values_from = pc) %>%
#   mutate(tot_to_fte_scale = FTE / Total) %>%
#   filter(!is.na(tot_to_fte_scale)) %>%
#   select(end_period_year, disposal_type, gender, tot_to_fte_scale)

gen_disp_fte_birm <- gen_disp_fte %>%
  select(-c(count, tot)) %>%
  full_join(gen_disp_pc %>%
              bind_rows(gen_disp_pc %>%
                          filter(end_period_year == 2010) %>%
                          mutate(end_period_year = end_period_year -1))) %>%
  filter(disposal_type != "Other") %>%
  mutate(pc = pc * ew_to_birm_scale) %>%
  select(end_period_year, disposal_type, gender, pc) %>%
  mutate(disp_gen = paste(disposal_type, gender, sep = "_")) %>%
  select(-c(disposal_type, gender)) %>%
  group_by(end_period_year) %>%
  pivot_wider(names_from = disp_gen, values_from = pc) %>%
  mutate(tot = Community_Boys + Custody_Boys + `Pre-court_Boys` + `First-tier_Boys` +
           Community_Girls + Custody_Girls + `Pre-court_Girls` + `First-tier_Girls`,
         check = 1 - tot) %>%
  mutate(across(c(Community_Boys:`Pre-court_Girls`), ~ .x + (.x / tot) * check)) %>%
  select(-c(tot, check)) %>%
  pivot_longer(c(Community_Boys:`Pre-court_Girls`),
               names_to = "disp_gen", values_to = "pc") %>%
  mutate(disposal_type = sub("_.*", "", disp_gen),
         gender = sub(".*_", "", disp_gen)) %>%
  select(-disp_gen)

#
#
# gender_pc_tot_birm <- disposals %>%
#   filter(level == "Birmingham") %>%
#   group_by(end_period_year, gender, disposal_type) %>%
#   summarise(count = sum(count)) %>%
#   ungroup() %>%
#   filter(!is.na(count)) %>%
#   group_by(end_period_year) %>%
#   mutate(tot = sum(count),
#          pc = count / tot) %>%
#   select(-c(count, tot)) %>%
#   full_join(gen_disp_pc) %>%
#   filter(!is.na(tot_to_fte_scale)) %>%
#   mutate(fte_pc = pc * tot_to_fte_scale) %>%
#   select(end_period_year, disposal_type, gender, fte_pc) %>%
#   mutate(disp_gen = paste(disposal_type, gender, sep = "_")) %>%
#   select(-c(disposal_type, gender)) %>%
#   group_by(end_period_year) %>%
#   pivot_wider(names_from = disp_gen, values_from = fte_pc) %>%
#   mutate(tot = Community_Boys + Custody_Boys + `Pre-court_Boys` + `First-tier_Boys` +
#                         Community_Girls + Custody_Girls + `Pre-court_Girls` + `First-tier_Girls`,
#          check = 1- tot) %>%
#   mutate(across(c(Community_Boys:`Pre-court_Girls`), ~ .x + (.x / tot) * check)) %>%
#   select(-c(tot, check)) %>%
#   pivot_longer(c(Community_Boys:`Pre-court_Girls`),
#               names_to = "disp_gen", values_to = "fte_pc") %>%
#   mutate(disposal_type = sub("_.*", "", disp_gen),
#          gender = sub(".*_", "", disp_gen)) %>%
#   select(-disp_gen)

check_pc_birm <- gen_disp_fte_birm %>%
  mutate(level = "Birmingham (adjusted)") %>%
  bind_rows(gen_disp_fte %>%
              select(-c(count, tot))) %>%
  filter(gender != "Unknown", disposal_type != "Other") %>%
  mutate(disposal_type = factor(disposal_type,
                                levels = c("Pre-court", "First-tier", "Community", "Custody"))) %>%
  ggplot() +
  geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, level))) +
  facet_grid(~disposal_type) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
check_pc_birm

ggsave(filename = "Output/Graphs/assumption_checks/birm_v_ew_fte_gen_disp.png", check_pc_birm)
# this looks more promising perhaps????


#
#
#
# check_pc_birm <- gender_pc_tot_birm %>%
#   mutate(measure = "adjusted fte") %>%
#   rename(pc = fte_pc) %>%
#   bind_rows(disposals %>%
#               filter(level == "Birmingham") %>%
#               group_by(end_period_year, gender, disposal_type) %>%
#               summarise(count = sum(count)) %>%
#               ungroup() %>%
#               filter(!is.na(count)) %>%
#               group_by(end_period_year) %>%
#               mutate(tot = sum(count),
#                      pc = count / tot) %>%
#               select(-c(count, tot)) %>%
#               mutate(measure = "total")) %>%
#   mutate(disposal_type = factor(disposal_type,
#                                 levels = c("Pre-court", "First-tier", "Community", "Custody"))) %>%
#   filter(gender != "Unknown") %>%
#   ggplot() +
#   geom_line(aes(x = end_period_year, y = pc, colour = interaction(gender, measure))) +
#   facet_grid(~disposal_type) +
#   scale_x_continuous(name = "") +
#   scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
#   theme_classic() +
#   theme(strip.background = element_blank()) +
#   scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
# check_pc_birm
#
# ggsave(filename = "Output/Graphs/assumption_checks/tot_v_fte_gen_disp_birm.png", check_pc_birm)

# slightly concerned about how drastic these changes are


level_pc <- fte_09to20 %>%
  pivot_wider(names_from = level, values_from = count) %>%
  mutate(pc = Birmingham / `Eng/Wales`) %>%
  filter(end_period_year == 2020) %>%
  select(pc) %>%
  unlist()


fte <- fte_09to20 %>%
  filter(level == "Birmingham") %>%
  bind_rows(fte_09to21_disposal_gender %>% # adding scaled down fte total for 2021
              ungroup() %>%
              filter(end_period_year == 2021) %>%
              group_by(end_period_year, end_period_month, period_length, level) %>%
              summarise(count = sum(count)) %>%
              mutate(count = count * level_pc,
                     level = "Birmingham (estimate)")) %>%
  full_join(gen_disp_fte_birm %>%
              select(-end_period_month)) %>%
  mutate(count = count * pc) %>%
  select(-pc) %>%
  ungroup()

save(fte, file = "Output/Data/Processed/fte.Rdata")


# fte <- fte_09to20 %>%
#   filter(level == "Birmingham") %>%
#   bind_rows(fte_09to21_disposal_gender %>% # adding scaled down fte total for 2021
#               ungroup() %>%
#               filter(end_period_year == 2021) %>%
#               group_by(end_period_year, end_period_month, period_length, level) %>%
#               summarise(count = sum(count)) %>%
#               mutate(count = count * level_pc,
#                      level = "Birmingham (estimate)")) %>%
#   full_join(gender_pc_tot_birm %>%
#               bind_rows(gender_pc_tot_birm %>%
#                           filter(end_period_year == 2010) %>%
#                           mutate(end_period_year = end_period_year -1))) %>%
#   mutate(count = count * fte_pc) %>%
#   select(-fte_pc) %>%
#   ungroup()


check <- fte %>%
  select(-c(end_period_month, period_length, level)) %>%
  mutate(measure = "fte") %>%
  bind_rows(disposals %>%
              filter(level == "Birmingham") %>%
              group_by(end_period_year, gender, disposal_type) %>%
              summarise(count = sum(count)) %>%
              ungroup() %>%
              filter(!is.na(count)) %>%
              mutate(measure = "total"))

check_fte <- check %>%
  mutate(disposal_type = factor(disposal_type,
                                levels = c("Pre-court", "First-tier", "Community", "Custody"))) %>%
  filter(gender != "Unknown") %>%
  ggplot() +
  geom_line(aes(x = end_period_year, y = count, colour = interaction(gender, measure))) +
  facet_grid(~disposal_type) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
check_fte

# SO! THis still doesn't work! But actually it works sort of ok for the custody section at the very very least.
# and is custody vs non-custody kind of the only important thing??


check_fte_custody <- check %>%
  filter(gender != "Unknown",
         disposal_type == "Custody") %>%
  ggplot() +
  geom_line(aes(x = end_period_year, y = count, colour = interaction(gender, measure))) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "", expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  scale_color_manual(values=c("Light blue", "Pink", "Navy", "Red"))
check_fte_custody

ggsave(filename = "Output/Graphs/assumption_checks/tot_v_fte_gen_custody_birm.png", check_fte_custody)


params_fte_custody <- fte %>%
  select(-c(end_period_month, period_length, level)) %>%
  filter(gender != "Unknown",
         disposal_type != "Other") %>%
  group_by(end_period_year, gender) %>%
  mutate(tot = sum(count),
         pc_of_gender_group = count / tot) %>%
  ungroup() %>%
  group_by(end_period_year) %>%
  mutate(tot = sum(count),
         pc_of_year = count / tot) %>%
  filter(disposal_type == "Custody") %>%
  select(-c(disposal_type, count, tot)) %>%
  mutate(name = "fte2c_sent") %>%
  pivot_longer(starts_with("pc"),
               names_to = "measure", values_to = "value")

save(params_fte_custody, file = "Output/Data/Processed/params_fte_custody.Rdata")


# ---OK NEW # ---# ---# ---# ---# ---# ---# ---# ---# ---v
# load("/Users/katehayes/CLmodelR/Output/Data/Processed/fte.Rdata")
#
# # slightly too many girls - want to change
# fte <- fte %>%
#   pivot_wider(names_from = gender,
#               values_from = count) %>%
#   mutate(Girls = Girls*0.75,
#          Boys = Boys + Girls*0.25) %>%
#   pivot_longer(c(Girls, Boys),
#                names_to = "gender", values_to = "count")
#
# # based on the graphs above that adjustment looks a little better!
#
# save(fte, file = "Output/Data/Processed/fte.Rdata")
load("/Users/katehayes/CLmodelR/Output/Data/Processed/fte.Rdata")

fte_nc_cust <- fte %>%
  pivot_wider(names_from = disposal_type,
              values_from = count) %>%
  mutate(`Non-custodial` = `Pre-court` + `Community` + `First-tier`) %>%
  select(-c(`Pre-court`, `Community`, `First-tier`)) %>%
  pivot_longer(c(Custody, `Non-custodial`),
               names_to = "disposal_type", values_to = "count") %>%
  mutate(t = (end_period_year - 2009)*52) %>%
  select(t, gender, disposal_type, count) %>%
  filter(t <= 520)

# age info???

# come back and read this in properly when you have time
# fte_age <- read_xlsx("/Users/katehayes/temp_data/Youth_Justice_Statistics_2020-21_supplementary_tables/Ch 2 - First time entrants to the youth justice system.xls", sheet = 4)

fte_data <- read_xlsx("/Users/katehayes/CLmodelR/temp_data/fte_age_ew.xlsx")

fte_age_plot <- fte_data %>%
  rename(`10-12`= `45270`,
         year = `Year ending March`) %>%
  pivot_longer(c(`10-12`:`17`),
               names_to = "age", values_to = "pc") %>%
  ggplot() +
  geom_line(aes(x = year, y = pc, group = age, color = age)) +
  facet_grid(~type)

fte_age_plot
  # so there do seem to be some trends over time -
# and also there seems to be a difference - where if you're going to commit a violence crime you're more likely to do it early
# not very coherent atm but yeah will use voilence for the age spread of fte custodial
# and total for the nc - i should have it as total minus violence but...

fte_age <- fte_data %>%
  rename(`10-12`= `45270`,
         t = `Year ending March`,
         disposal_type = type) %>%
  mutate(disposal_type = if_else(disposal_type == "total",
                                 "Non-custodial", "Custody")) %>%
  mutate(t = (as.numeric(t) - 2011)*52)


  # x <- 1

fte_nc_cust_age <- fte_nc_cust %>%
  # pivot_wider(names_from = gender, values_from = count) %>%
  left_join(fte_age) %>%
  mutate(count = count/12) %>%
  mutate(`10-12` = as.numeric(`10-12`)*count,
         `13` = as.numeric(`13`)*count,
         `14` = as.numeric(`14`)*count,
         `15` = as.numeric(`15`)*count,
         `16` = as.numeric(`16`)*count,
         `17` = as.numeric(`17`)*count,
         `10` = `10-12`*0.2,
         `11` = `10-12`*0.35,
         `12` = `10-12`*0.45) %>%
  select(-c(count, `10-12`)) %>%
  pivot_longer(c(starts_with("1")),
               names_to = "age", values_to = "count") %>%
  mutate(Included = case_when(gender == "Girls" ~ count/2234.4,
                              gender == "Boys" ~ count/2885.625),
         `Excluded/Close` = case_when(gender == "Girls" ~ (count/2234.4)*2,
                                      gender == "Boys" ~ (count/2885.625)*2)) %>%
  select(-count) %>%
  pivot_longer(c(Included, `Excluded/Close`),
               names_to = "class", values_to = "rate") %>%
  pivot_wider(names_from = gender, values_from = rate) %>%
  arrange(t)




tnp <- fte_nc_cust_age %>%
  ungroup() %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 10)

tnp <- tnp$t

np2csi10 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 10) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi11 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 11) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi12 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 12) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi13 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 13) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi14 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 14) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()


np2csi15 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 15) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi16 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 16) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csi17 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Included",
         age == 17) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec10 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 10) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec11 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 11) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec12 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 12) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec13 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 13) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec14 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 14) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()


np2csec15 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 15) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec16 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 16) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2csec17 <- fte_nc_cust_age %>%
  filter(disposal_type == "Custody",
         class == "Excluded/Close",
         age == 17) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci10 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 10) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci11 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 11) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci12 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 12) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci13 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 13) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci14 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 14) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()


np2nci15 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 15) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci16 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 16) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2nci17 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Included",
         age == 17) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec10 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 10) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec11 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 11) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec12 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 12) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec13 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 13) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec14 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 14) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()


np2ncec15 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 15) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec16 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 16) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()

np2ncec17 <- fte_nc_cust_age %>%
  filter(disposal_type == "Non-custodial",
         class == "Excluded/Close",
         age == 17) %>%
  ungroup() %>%
  select(Boys, Girls) %>%
  as.matrix()


save(tnp, file = "Output/Data/Input/tnp.Rdata")

save(np2csi10, file = "Output/Data/Input/np2csi10.Rdata")
save(np2csi11, file = "Output/Data/Input/np2csi11.Rdata")
save(np2csi12, file = "Output/Data/Input/np2csi12.Rdata")
save(np2csi13, file = "Output/Data/Input/np2csi13.Rdata")
save(np2csi14, file = "Output/Data/Input/np2csi14.Rdata")
save(np2csi15, file = "Output/Data/Input/np2csi15.Rdata")
save(np2csi16, file = "Output/Data/Input/np2csi16.Rdata")
save(np2csi17, file = "Output/Data/Input/np2csi17.Rdata")
save(np2csec10, file = "Output/Data/Input/np2csec10.Rdata")
save(np2csec11, file = "Output/Data/Input/np2csec11.Rdata")
save(np2csec12, file = "Output/Data/Input/np2csec12.Rdata")
save(np2csec13, file = "Output/Data/Input/np2csec13.Rdata")
save(np2csec14, file = "Output/Data/Input/np2csec14.Rdata")
save(np2csec15, file = "Output/Data/Input/np2csec15.Rdata")
save(np2csec16, file = "Output/Data/Input/np2csec16.Rdata")
save(np2csec17, file = "Output/Data/Input/np2csec17.Rdata")

save(np2nci10, file = "Output/Data/Input/np2nci10.Rdata")
save(np2nci11, file = "Output/Data/Input/np2nci11.Rdata")
save(np2nci12, file = "Output/Data/Input/np2nci12.Rdata")
save(np2nci13, file = "Output/Data/Input/np2nci13.Rdata")
save(np2nci14, file = "Output/Data/Input/np2nci14.Rdata")
save(np2nci15, file = "Output/Data/Input/np2nci15.Rdata")
save(np2nci16, file = "Output/Data/Input/np2nci16.Rdata")
save(np2nci17, file = "Output/Data/Input/np2nci17.Rdata")
save(np2ncec10, file = "Output/Data/Input/np2ncec10.Rdata")
save(np2ncec11, file = "Output/Data/Input/np2ncec11.Rdata")
save(np2ncec12, file = "Output/Data/Input/np2ncec12.Rdata")
save(np2ncec13, file = "Output/Data/Input/np2ncec13.Rdata")
save(np2ncec14, file = "Output/Data/Input/np2ncec14.Rdata")
save(np2ncec15, file = "Output/Data/Input/np2ncec15.Rdata")
save(np2ncec16, file = "Output/Data/Input/np2ncec16.Rdata")
save(np2ncec17, file = "Output/Data/Input/np2ncec17.Rdata")





  # ok v rough from ACEs, Places and Inequality but lets say E and C have roughly
# double the change of offending than I

# count = rate_x*6384*0.15 + 2*rate_x*1596*0.4
# count = 2234.4*rate_x
# rate_x = count/2234.4
#
# count = rate_x*6412.5*0.15 + 2*rate_x*2137.5*0.45
# count = 2885.625*rate_x
